<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<title>Consent To Research</title>
<script src="vue.min.js"></script>
<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<style>
    html, body {
        margin: 0;
        padding: 0;
    }
    * {
        font: 14px/18px Lato,'Helvetica Neue',Arial,Helvetica,sans-serif;
        box-sizing: border-box;
    }
    #document {
        position: relative;
        margin: .25in auto;
        max-width: 8.5in;
        background-color: white;
        padding: 1in;
        -webkit-box-shadow: 0 0 4px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 0 4px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);        
    }
    #document div *:first-child {
        margin-top: 0;
    }
    #document div *:last-child {
        margin-bottom: 0;
    }
    #document:before, #document:after {
        position: absolute;
        width: 40%;
        height: 10px;
        content: ' ';
        left: 12px;
        bottom: 14px;
        background: transparent;
        -webkit-transform: skew(-5deg) rotate(-5deg);
        -moz-transform: skew(-5deg) rotate(-5deg);
        -ms-transform: skew(-5deg) rotate(-5deg);
        -o-transform: skew(-5deg) rotate(-5deg);
        transform: skew(-5deg) rotate(-5deg);
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        z-index: -1;
    } 
    #document:after {
        left: auto;
        right: 12px;
        -webkit-transform: skew(5deg) rotate(5deg);
        -moz-transform: skew(5deg) rotate(5deg);
        -ms-transform: skew(5deg) rotate(5deg);
        -o-transform: skew(5deg) rotate(5deg);
        transform: skew(5deg) rotate(5deg);
    }
    table {
        width: 100%;
        margin: .75in 0 0 0;
    }
    .line {
        border-top: 2px solid black;
    }
    .loader {
        margin-top: 50px;
        text-align: center;
    }
    @media print {
        body {
            margin: .5in;
        }
        #document {
            padding: 0;
            margin: 0;
        }
    }
</style>
</head>
<body>
<div id="document">
    <div v-html="document">
        <div class="loader">Loading&hellip;</div>
    </div>
    <table cellspacing="0">
        <tr>
            <td nowrap="nowrap" valign="bottom">{{name}}</td>
            <td></td>
            <td nowrap="nowrap"><img :src="signature" /></td>
            <td></td>
            <td nowrap="nowrap" valign="bottom">{{signedOn}}</td>
        </tr>
        <tr>
            <td class="line">Name of Participant</td>
            <td></td>
            <td class="line">Signature</td>
            <td></td>
            <td class="line">Date</td>
        </tr>
        <tr>
            <td colspan="5"><br /></td>
        </tr>
        <tr>
            <td nowrap="nowrap">{{email}}</td>
            <td></td>
            <td nowrap="nowrap">{{sharing_status}}</td>
            <td></td>
            <td nowrap="nowrap">{{birthdate}}</td>
        </tr>
        <tr>
            <td width="30%" class="line">Email</td>
            <td width="5%"></td>
            <td width="30%" class="line">Sharing Option</td>
            <td width="5%"></td>
            <td width="30%" class="line">Birth Date</td>
        </tr>
        <tr>
            <td colspan="5"><br /></td>
        </tr>
        <tr>
            <td width="15%" nowrap="nowrap">{{withdrewOn}}</td>
        </tr>
        <tr>
            <td width="15%"  class="line" v-show="hasWithdrawn">Withdrew On</td>
        </tr>
    </table>    
</div>
<script>
function showError() {
    document.body.innerHTML = '<p class="loader">You are signed out of the Bridge Study Manager. Sign back in to view content.</p>';
}
var session = JSON.parse(localStorage.getItem('session'));
if (!session) {
    showError();
}
var queryParams = {};
if (document.location.search) {
    document.location.search.substring(1).split("&").forEach(function(pair) {
        var fragments = pair.split("=");
        var key = decodeURIComponent(fragments[0]);
        var value = decodeURIComponent(fragments[1]);
        queryParams[key] = value;
    });
}
var sharing = {
    'no_sharing': 'Not Sharing',
    'sponsors_and_partners': 'Sponsors and Partners Only',
    'all_qualified_researchers': 'All Qualified Researchers'
};
var HEADERS = {
    'Bridge-Session': session.sessionToken,
    'Content-Type': 'application/json'
};
function config(url) {
    return {
        method: 'GET',
        url: queryParams.host + url,
        headers: {'Bridge-Session': session.sessionToken,'Content-Type': 'application/json'},
        type: "application/json",
        dataType: "json"
    };
}

$.ajax(config('/v3/participants/' + queryParams.userId)).done(function(response) {
    var user = response;
    var history = user.consentHistories[queryParams.guid][queryParams.index];
    var signedOn = (history.signedOn) ? new Date(history.signedOn).toLocaleString() : '';
    var withdrewOn = (history.withdrewOn) ? new Date(history.withdrewOn).toLocaleString() : '';
    var signature = (history.imageData) ? "data:"+history.imageMimeType+";base64,"+history.imageData : '';
    
    var data = {
        name: history.name,
        signature: signature,
        signedOn: signedOn,
        birthdate: history.birthdate,
        hasWithdrawn: typeof history.withdrewOn === "string",
        withdrewOn: withdrewOn,
        date: history.birthdate,
        email: user.email,
        sharing_status: sharing[user.sharingScope]
    };
    var url = '/v3/subpopulations/'+queryParams.guid+'/consents/'+history.consentCreatedOn;
    return $.ajax(config(url)).done(function(response) {
        data.document = response.documentContent;
        new Vue({el: document.getElementById('document'),data: data});
    }).fail(showError);
}).fail(showError);
</script>
</body>
</html>