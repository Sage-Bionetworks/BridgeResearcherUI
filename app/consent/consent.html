<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<title>Consent To Research</title>
<script src="vue.min.js"></script>
<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<style>
    html, body {
        margin: 0;
        padding: 0;
    }
    * {
        font: 14px/18px Lato,'Helvetica Neue',Arial,Helvetica,sans-serif;
        box-sizing: border-box;
    }
    #document {
        position: relative;
        margin: .25in auto;
        max-width: 8.5in;
        background-color: white;
        padding: 1in;
        -webkit-box-shadow: 0 0 4px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 0 4px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.1);        
    }
    #document div *:first-child {
        margin-top: 0;
    }
    #document div *:last-child {
        margin-bottom: 0;
    }
    #document:before, #document:after {
        position: absolute;
        width: 40%;
        height: 10px;
        content: ' ';
        left: 12px;
        bottom: 14px;
        background: transparent;
        -webkit-transform: skew(-5deg) rotate(-5deg);
        -moz-transform: skew(-5deg) rotate(-5deg);
        -ms-transform: skew(-5deg) rotate(-5deg);
        -o-transform: skew(-5deg) rotate(-5deg);
        transform: skew(-5deg) rotate(-5deg);
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        z-index: -1;
    } 
    #document:after {
        left: auto;
        right: 12px;
        -webkit-transform: skew(5deg) rotate(5deg);
        -moz-transform: skew(5deg) rotate(5deg);
        -ms-transform: skew(5deg) rotate(5deg);
        -o-transform: skew(5deg) rotate(5deg);
        transform: skew(5deg) rotate(5deg);
    }
    table {
        width: 100%;
    }
    .line {
        border-top: 2px solid #333;
    }
    .loader {
        padding: 50px 0;
        text-align: center;
    }
    img {
        width: calc(334px * .6);
        height: calc(156px * .6);
        visibility: hidden;
    }
    @media print {
        body {
            margin: .5in;
        }
        #document {
            padding: 0;
            margin: 0;
        }
    }
</style>
</head>
<body>
<div id="document">
    <div v-html="document">
        <div class="loader">Loading&hellip;</div>
    </div>
    <table cellspacing="0">
        <tr>
            <td nowrap="nowrap" valign="bottom">{{name}}</td>
            <td></td>
            <td nowrap="nowrap"><img :style="imgStyle" :src="signature" /></td>
            <td></td>
            <td nowrap="nowrap" valign="bottom">{{signedOn}}</td>
        </tr>
        <tr>
            <td class="line">Name of Participant</td>
            <td></td>
            <td class="line">Signature</td>
            <td></td>
            <td class="line">Date</td>
        </tr>
        <tr>
            <td colspan="5"><br /></td>
        </tr>
        <tr>
            <td>{{email}}</td>
            <td></td>
            <td>{{sharing_status}}</td>
            <td></td>
            <td>{{birthdate}}</td>
        </tr>
        <tr>
            <td width="31%" class="line">Email</td>
            <td width="3%">&#160;&#160;&#160;</td>
            <td width="32%" class="line">Sharing Option</td>
            <td width="3%">&#160;&#160;&#160;</td>
            <td width="31%" class="line">Birth Date</td>
        </tr>
        <tr>
            <td colspan="5"><br /></td>
        </tr>
        <tr>
            <td width="15%">{{withdrewOn}}</td>
        </tr>
        <tr>
            <td width="15%"  class="line" v-show="hasWithdrawn">Withdrew On</td>
        </tr>
    </table>    
</div>
<script>
function showError() {
    document.body.innerHTML = '<p class="loader">You are signed out of the Bridge Study Manager. Sign back in to view content.</p>';
}
var session = JSON.parse(localStorage.getItem('session'));
if (!session) {
    showError();
}
var queryParams = {};
if (document.location.search) {
    document.location.search.substring(1).split("&").forEach(function(pair) {
        var fragments = pair.split("=");
        var key = decodeURIComponent(fragments[0]);
        var value = decodeURIComponent(fragments[1]);
        queryParams[key] = value;
    });
}
var sharing = {
    'no_sharing': 'Not Sharing',
    'sponsors_and_partners': 'Sponsors and Partners Only',
    'all_qualified_researchers': 'All Qualified Researchers'
};
var HEADERS = {
    'Bridge-Session': session.sessionToken,
    'Content-Type': 'application/json'
};
function config(url) {
    return {
        method: 'GET',
        url: queryParams.host + url,
        headers: {'Bridge-Session': session.sessionToken,'Content-Type': 'application/json'},
        type: "application/json",
        dataType: "json"
    };
}

$.ajax(config('/v3/participants/' + queryParams.userId)).done(function(response) {
    var user = response;
    var history = user.consentHistories[queryParams.guid][queryParams.index];
    var signedOn = (history.signedOn) ? new Date(history.signedOn).toLocaleString() : '';
    var withdrewOn = (history.withdrewOn) ? new Date(history.withdrewOn).toLocaleString() : '';
    var signature = (history.imageData) ? "data:"+history.imageMimeType+";base64,"+history.imageData : '';
    
    signature = "data:image/png;base64,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";

    var data = {
        name: history.name,
        signature: signature,
        signedOn: signedOn,
        birthdate: history.birthdate,
        hasWithdrawn: typeof history.withdrewOn === "string",
        withdrewOn: withdrewOn,
        date: history.birthdate,
        email: user.email,
        sharing_status: sharing[user.sharingScope],
        imgStyle: {visibility: "visible"}
    };
    var url = '/v3/subpopulations/' + queryParams.guid + '/consents/' + history.consentCreatedOn;
    return $.ajax(config(url)).done(function(response) {
        data.document = response.documentContent;
        new Vue({el: document.getElementById('document'), data: data});
    }).fail(showError);
}).fail(showError);
</script>
</body>
</html>